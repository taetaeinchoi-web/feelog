<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>그날의 기록 – FEELOG</title>
  <link rel="stylesheet" href="history.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/static/pretendard.css" />
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>

<body id="page">

  <main id="capture-area" class="content">
    <!-- 사진 영역 -->
    <div id="photo-area" class="photo-area hidden">
      <img id="photo" src="" alt="기록 사진">
    </div>

    <p id="text" class="text"></p>
    <p id="date" class="date"></p>
  </main>

  <div class="actions">
    <a href="result.html" class="back-link">← 전체 기록</a>
    <button id="saveImg" class="save-btn">이미지로 저장</button>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const id = params.get("id");
    const arr = JSON.parse(localStorage.getItem("feelog") || "[]");
    const entry = arr.find(e => e.id === id);

    function getLuma(hex) {
      hex = hex.replace("#", "");
      const r = parseInt(hex.substring(0, 2), 16);
      const g = parseInt(hex.substring(2, 4), 16);
      const b = parseInt(hex.substring(4, 6), 16);
      return 0.2126 * r + 0.7152 * g + 0.0722 * b;
    }

    if (entry) {
      const bg = entry.color;
      document.getElementById("page").style.background = bg;

      const luma = getLuma(bg);
      const textColor = (luma < 140) ? "#ffffff" : "#000000";
      document.body.style.color = textColor;

      // 사진 표시
      if (entry.photo) {
        document.getElementById("photo-area").classList.remove("hidden");
        document.getElementById("photo").src = entry.photo;
      }

      const d = new Date(entry.date);
      const formatted = `${d.getFullYear()}.${String(d.getMonth() + 1).padStart(2, '0')}.${String(d.getDate()).padStart(2, '0')}`;

      document.getElementById("text").textContent = entry.text || "";
      document.getElementById("date").textContent = formatted;
    } else {
      document.getElementById("text").textContent = "기록을 찾을 수 없어요.";
    }

    /* 이미지 저장 */
    document.getElementById("saveImg").addEventListener("click", () => {
      const target = document.getElementById("capture-area");
      const bgColor = getComputedStyle(document.getElementById("page")).backgroundColor;

      html2canvas(target, {
        scale: 2,
        backgroundColor: bgColor,
        useCORS: true
      }).then(canvas => {
        const link = document.createElement("a");
        link.download = "feelog_" + id + ".png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      });
    });
  </script>

</body>

</html>